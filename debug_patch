@app.post("/agent", response_class=StreamingResponse)
async def run_agent(request: Request):
    try:
        body = await request.json()
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid JSON body")

    thread_id = body.get("thread_id") or f"thread-{uuid.uuid4().hex[:8]}"
    run_id = body.get("run_id") or f"run-{uuid.uuid4().hex[:8]}"
    messages = body.get("messages", [])
    
    # ðŸŽ¯ DEBUG CODE 1: Context storage status
    print("=" * 50)
    print("ðŸŽ¯ DEBUG: NEW REQUEST RECEIVED")
    print(f"ðŸŽ¯ Thread ID: {thread_id}")
    print(f"ðŸŽ¯ Total messages: {len(messages)}")
    print(f"ðŸŽ¯ Current route_selection_context keys: {list(route_selection_context.keys())}")
    print("=" * 50)
    
    # Last message print karo
    if messages:
        last_msg = messages[-1]
        print(f"ðŸŽ¯ Last message: {last_msg}")
  ###########################################
  # Tool execution loop ke andar
try:
    tool_result = await mcp_client.invoke_tool(tool_name, args)
    
    # ðŸŽ¯ DEBUG CODE 2: Tool result check
    print(f"ðŸŽ¯ DEBUG: Tool {tool_name} result: {json.dumps(tool_result, indent=2)}")
    
    # Check if multiple routes are available
    if (tool_name == "get_delay_summary" and 
        isinstance(tool_result, dict) and 
        tool_result.get("ok")):
        
        data = tool_result.get("data", {})
        print(f"ðŸŽ¯ DEBUG: Tool data status: {data.get('status')}")
        
        if data.get("status") == "route_selection_required":
            print("ðŸŽ¯ DEBUG: âœ… ROUTE SELECTION REQUIRED - Storing context...")
            
            # Store context
            route_selection_context[thread_id] = {
                "available_routes": data["available_routes"],
                "original_args": args
            }
            
            print(f"ðŸŽ¯ DEBUG: âœ… Context stored for thread: {thread_id}")
            print(f"ðŸŽ¯ DEBUG: Available routes: {len(data['available_routes'])}")
            print(f"ðŸŽ¯ DEBUG: Original args: {args}")
            print(f"ðŸŽ¯ DEBUG: Now route_selection_context has: {list(route_selection_context.keys())}")
  ####################################################
  # ðŸŽ¯ DEBUG CODE 3: Route selection context check
print("ðŸŽ¯ DEBUG: Checking route selection context...")
print(f"ðŸŽ¯ DEBUG: Current thread_id: {thread_id}")
print(f"ðŸŽ¯ DEBUG: All context keys: {list(route_selection_context.keys())}")

is_route_selection = False
user_selected_route = None
original_tool_args = None

if thread_id in route_selection_context:
    print("ðŸŽ¯ DEBUG: âœ… THREAD ID FOUND IN CONTEXT!")
    context = route_selection_context[thread_id]
    print(f"ðŸŽ¯ DEBUG: Context data: {context.keys()}")
    
    # This is a follow-up message for route selection
    if messages:
        last_message = messages[-1]
        if isinstance(last_message, dict) and last_message.get("role") == "user":
            user_input = last_message.get("content", "").strip()
            print(f"ðŸŽ¯ DEBUG: User input for route selection: '{user_input}'")
            
            is_route_selection = True
            available_routes = context.get("available_routes", [])
            original_tool_args = context.get("original_args", {})
            
            print(f"ðŸŽ¯ DEBUG: Available routes count: {len(available_routes)}")
            print(f"ðŸŽ¯ DEBUG: Original args: {original_tool_args}")
            
            # Parse user's route selection
            try:
                numbers = re.findall(r'\d+', user_input)
                print(f"ðŸŽ¯ DEBUG: Extracted numbers: {numbers}")
                
                if numbers:
                    route_number = int(numbers[0])
                    print(f"ðŸŽ¯ DEBUG: Route number: {route_number}")
                    
                    if 1 <= route_number <= len(available_routes):
                        selected_route = available_routes[route_number - 1]["route_id"]
                        user_selected_route = selected_route
                        print(f"ðŸŽ¯ DEBUG: âœ… Valid selection - Route: {selected_route}")
                    else:
                        user_selected_route = "invalid"
                        print(f"ðŸŽ¯ DEBUG: âŒ Invalid route number")
                else:
                    user_selected_route = "invalid"
                    print(f"ðŸŽ¯ DEBUG: âŒ No numbers found")
            except Exception as e:
                user_selected_route = "invalid"
                print(f"ðŸŽ¯ DEBUG: âŒ Error parsing: {e}")
else:
    print("ðŸŽ¯ DEBUG: âŒ THREAD ID NOT FOUND IN CONTEXT")
